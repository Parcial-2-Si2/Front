<!-- Breadcrumb -->
<div class="pagetitle">
  <h1>Boletín de Calificaciones</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/dashboard">Home</a></li>
      <li class="breadcrumb-item active">Boletín</li>
    </ol>
  </nav>
</div>

<!-- Formulario de búsqueda -->
<div class="card mb-4">  <div class="card-body">
    <h5 class="card-title">Consultar Boletín de Calificaciones</h5>
    
    <!-- Estado de conexión -->
    <div class="alert alert-info d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center">
        <i class="bi" [ngClass]="getIconoConexion() + ' ' + getClaseConexion()"></i>
        <span class="ms-2" [ngClass]="getClaseConexion()">{{ getTextoConexion() }}</span>
      </div>
      <button 
        type="button" 
        class="btn btn-outline-primary btn-sm"
        (click)="verificarConexion()"
        [disabled]="verificandoConexion">
        <i class="bi bi-arrow-clockwise"></i>
        <span *ngIf="!verificandoConexion">Verificar</span>
        <span *ngIf="verificandoConexion">Verificando...</span>
      </button>
    </div>
    
    <div class="row g-3">
      <div class="col-md-6">
        <label for="estudianteCi" class="form-label">CI del Estudiante</label>
        <input 
          type="text" 
          id="estudianteCi"
          class="form-control"
          [(ngModel)]="estudianteCi" 
          placeholder="Ingrese el CI del estudiante"
          (keyup)="onEnterKey($event)"
          [disabled]="cargando">
      </div>
      <div class="col-md-6 d-flex align-items-end">
        <div class="btn-group" role="group">
          <button 
            type="button" 
            class="btn btn-primary"
            (click)="buscarBoletin()" 
            [disabled]="cargando || !estudianteCi.trim()">
            <i class="bi bi-search"></i>
            <span *ngIf="!cargando">Buscar Boletín</span>
            <span *ngIf="cargando">Cargando...</span>
          </button>
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="limpiar()" 
            [disabled]="cargando">
            <i class="bi bi-trash"></i> Limpiar
          </button>
        </div>
      </div>
    </div>    <!-- Mensaje de error -->
    <div *ngIf="error" class="alert alert-danger mt-3" role="alert">
      <i class="bi bi-exclamation-triangle"></i>
      {{ error }}      <div *ngIf="estadoConexion === 'desconectado'" class="mt-2 small">
        <strong>Posibles soluciones:</strong>
        <ul class="mb-0 mt-1">
          <li>Verifique que el backend esté ejecutándose en <code>http://localhost:5205</code></li>
          <li>Asegúrese de que el servidor de la API esté iniciado</li>
          <li>Verifique la configuración de CORS en el backend</li>
        </ul>
        <div class="mt-2">
          <button type="button" class="btn btn-outline-info btn-sm" (click)="usarDatosPrueba()">
            <i class="bi bi-database"></i> Usar datos de demostración
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Datos del boletín -->
<div *ngIf="boletinData">
  <!-- Información del estudiante -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <h5 class="card-title">Información del Estudiante</h5>
          <div class="row">
            <div class="col-md-6">
              <p><strong>Nombre:</strong> {{ boletinData.estudiante_nombre }}</p>
              <p><strong>CI:</strong> {{ boletinData.estudiante_ci }}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Gestión:</strong> {{ boletinData.gestion_anio }} - {{ boletinData.gestion_periodo }}</p>
              <p><strong>Promedio General:</strong> 
                <span class="badge" [ngClass]="'bg-' + getColorBadge(calcularPromedioGeneral())">
                  {{ calcularPromedioGeneral() }}
                </span>
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4 d-flex align-items-center justify-content-end">
          <div class="btn-group-vertical" role="group">
            <button 
              type="button" 
              class="btn btn-danger btn-sm mb-2"
              (click)="descargarPDF()">
              <i class="bi bi-file-pdf"></i> Descargar PDF
            </button>
            <button 
              type="button" 
              class="btn btn-success btn-sm"
              (click)="descargarExcel()">
              <i class="bi bi-file-excel"></i> Descargar Excel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de calificaciones -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Calificaciones por Materia</h5>
      
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th scope="col">Materia</th>
              <th scope="col" class="text-center">1er Trimestre</th>
              <th scope="col" class="text-center">2do Trimestre</th>
              <th scope="col" class="text-center">3er Trimestre</th>
              <th scope="col" class="text-center">Nota Final</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let materia of boletinData.materias; trackBy: trackByMateriaId">
              <td class="fw-bold">{{ materia.materia_nombre }}</td>
              <td class="text-center">
                <span *ngIf="materia.primer_trimestre" 
                      class="badge" 
                      [ngClass]="'bg-' + getColorBadge(materia.primer_trimestre)">
                  {{ materia.primer_trimestre }}
                </span>
                <span *ngIf="!materia.primer_trimestre" class="text-muted">-</span>
              </td>
              <td class="text-center">
                <span *ngIf="materia.segundo_trimestre" 
                      class="badge" 
                      [ngClass]="'bg-' + getColorBadge(materia.segundo_trimestre)">
                  {{ materia.segundo_trimestre }}
                </span>
                <span *ngIf="!materia.segundo_trimestre" class="text-muted">-</span>
              </td>
              <td class="text-center">
                <span *ngIf="materia.tercer_trimestre" 
                      class="badge" 
                      [ngClass]="'bg-' + getColorBadge(materia.tercer_trimestre)">
                  {{ materia.tercer_trimestre }}
                </span>
                <span *ngIf="!materia.tercer_trimestre" class="text-muted">-</span>
              </td>
              <td class="text-center">
                <span *ngIf="materia.nota_final" 
                      class="badge fs-6" 
                      [ngClass]="'bg-' + getColorBadge(materia.nota_final)">
                  {{ materia.nota_final }}
                </span>
                <span *ngIf="!materia.nota_final" class="text-muted">-</span>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="table-secondary">
              <th scope="row">PROMEDIO GENERAL</th>
              <td colspan="3"></td>
              <td class="text-center">
                <span class="badge fs-6" [ngClass]="'bg-' + getColorBadge(calcularPromedioGeneral())">
                  {{ calcularPromedioGeneral() }}
                </span>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Leyenda de colores -->
      <div class="mt-3">
        <h6>Escala de Calificaciones:</h6>
        <div class="d-flex flex-wrap gap-2">
          <span class="badge bg-success">90-100: Excelente</span>
          <span class="badge bg-primary">80-89: Bueno</span>
          <span class="badge bg-warning text-dark">70-79: Regular</span>
          <span class="badge bg-danger">0-69: Necesita Mejorar</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mensaje cuando no hay datos -->
<div *ngIf="!boletinData && !cargando && !error" class="card">
  <div class="card-body text-center py-5">
    <i class="bi bi-file-text display-1 text-muted mb-3"></i>
    <h3 class="text-muted">Buscar Boletín de Calificaciones</h3>
    <p class="text-muted">Ingrese el CI del estudiante para consultar su boletín de calificaciones.</p>
  </div>
</div>
