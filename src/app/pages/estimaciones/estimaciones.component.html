<div class="card">
  <div class="card-body">
    <h5 class="card-title">Generar Boletín Completo por Docente</h5>
    <form (ngSubmit)="generarBoletin()" class="row g-3">
      <div class="col-md-3">
  <label for="docente_ci" class="form-label">Docente</label>
  <select class="form-select" [(ngModel)]="docente_ci" name="docente_ci" required>
    <option *ngFor="let d of docentes" [value]="d.ci">{{ d.nombreCompleto }}</option>
  </select>
</div>

<div class="col-md-3">
  <label for="materia_id" class="form-label">Materia</label>
  <select class="form-select" [(ngModel)]="materia_id" name="materia_id" required>
    <option *ngFor="let m of materias" [value]="m.id">{{ m.nombre }}</option>
  </select>
</div>

<div class="col-md-3">
  <label for="curso_id" class="form-label">Curso</label>
  <select class="form-select" [(ngModel)]="curso_id" name="curso_id" required>
    <option *ngFor="let c of cursos" [value]="c.id">
      {{ c.nombre }}{{ c.paralelo ? ' - ' + c.paralelo : '' }} ({{ c.turno }})
    </option>
  </select>
</div>

      <div class="col-md-3">
        <label for="year" class="form-label">Año</label>
        <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="year" 
          name="year" 
          placeholder="Ej: 2025"
        />
        <small class="text-muted">Año académico</small>
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary" [disabled]="cargando">
          <span *ngIf="cargando" class="spinner-border spinner-border-sm me-2"></span>
          {{ cargando ? 'Generando...' : 'Generar' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Resultados -->
<div class="mt-4" *ngIf="resultado">  <!-- Resumen -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Resumen del Boletín</h5>
      
      <!-- Información del filtro aplicado -->
      <div class="alert alert-info mb-3">
        <h6 class="mb-2"><i class="bi bi-funnel text-primary"></i> Filtros Aplicados:</h6>
        <div class="row">
          <div class="col-md-4">
            <p class="mb-1"><strong>Docente:</strong> {{ docenteNombre }}</p>
            <small class="text-muted">CI: {{ docente_ci }}</small>
          </div>
          <div class="col-md-4">
            <p class="mb-1"><strong>Materia:</strong> {{ materiaNombre }}</p>
            <small class="text-muted">ID: {{ materia_id }}</small>
          </div>
          <div class="col-md-4">
            <p class="mb-1"><strong>Curso:</strong> {{ cursoNombre }}</p>
            <small class="text-muted">ID: {{ curso_id }}</small>
          </div>
        </div>
        <p class="mb-0 mt-2"><strong>Año:</strong> {{ year }}</p>
      </div>
      
      <div class="row">
        <div class="col-md-6">
          <p class="mb-1"><i class="bi bi-info-circle text-info"></i> {{ resultado.mensaje }}</p>
          <p class="mb-1"><strong>Total Estudiantes:</strong> {{ resumen.total_estudiantes }}</p>
        </div>
        <div class="col-md-6" *ngIf="resumen?.promedios_generales as promedios">
          <p class="mb-1"><strong>Promedio Final:</strong> 
            <span class="badge bg-primary">{{ promedios.nota_final }}</span>
          </p>
          <p class="mb-1"><strong>Promedio Estimado:</strong> 
            <span class="badge bg-info">{{ promedios.nota_estimada }}</span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Controles de tabla -->
  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">Listado de Estudiantes</h5>
        <small class="text-muted">{{ estudiantesFiltrados.length }} estudiante(s) encontrado(s)</small>
      </div>
      
      <!-- Controles de búsqueda y paginación -->
      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">Mostrar:</label>
          <select class="form-select form-select-sm" [(ngModel)]="limit" (change)="changeLimit()">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <div class="col-md-9">
          <label class="form-label">Buscar por período:</label>
          <input 
            type="text" 
            class="form-control form-control-sm" 
            [(ngModel)]="searchTerm" 
            (input)="searchTable()" 
            placeholder="Ej: 2025 - I, 2024 - II"
          />
        </div>
      </div>

      <!-- Tabla mejorada -->
      <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>CI</th>
              <th>Nombre Completo</th>
              <th>Promedio Final</th>
              <th>Promedio Estimado</th>
              <th>Períodos</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let est of estudiantesFiltrados | paginate: { itemsPerPage: limit, currentPage: page }">
              <td><strong>{{ est.ci }}</strong></td>
              <td>{{ est.nombreCompleto }}</td>
              <td>
                <span class="badge" [ngClass]="{
                  'bg-success': est.promedios.nota_final >= 70,
                  'bg-warning': est.promedios.nota_final >= 51 && est.promedios.nota_final < 70,
                  'bg-danger': est.promedios.nota_final < 51
                }">
                  {{ est.promedios.nota_final }}
                </span>
              </td>
              <td>
                <span class="badge" [ngClass]="{
                  'bg-success': est.promedios.nota_estimada >= 70,
                  'bg-warning': est.promedios.nota_estimada >= 51 && est.promedios.nota_estimada < 70,
                  'bg-danger': est.promedios.nota_estimada < 51
                }">
                  {{ est.promedios.nota_estimada }}
                </span>
              </td>
              <td>
                <div class="d-flex flex-wrap gap-1">
                  <span 
                    *ngFor="let p of est.periodos" 
                    class="badge bg-light text-dark border"
                    style="font-size: 0.75em;">
                    {{ p.anio }} - {{ p.periodo }} | 
                    F: {{ p.nota_final.valor }} | 
                    E: {{ p.nota_estimada.valor }}
                  </span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      <div class="d-flex justify-content-center mt-3" *ngIf="estudiantesFiltrados.length > limit">
        <pagination-controls 
          (pageChange)="page = $event"
          previousLabel="Anterior"
          nextLabel="Siguiente">
        </pagination-controls>
      </div>
    </div>
  </div>
</div>

<!-- Mensaje cuando no hay datos -->
<div class="alert alert-info mt-3" *ngIf="!cargando && !resultado && !error">
  <i class="bi bi-info-circle"></i> Complete los campos y presione "Generar" para obtener el boletín completo.
</div>

<!-- Error -->
<div *ngIf="error" class="alert alert-danger mt-3">
  <i class="bi bi-exclamation-triangle"></i> {{ error }}
</div>
